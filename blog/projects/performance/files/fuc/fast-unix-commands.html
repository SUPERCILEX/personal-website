<!doctype html><html class=min-height-full lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="light dark" name=color-scheme><link href=/favicon.ico rel=icon type=image/x-icon><link href=//fonts.gstatic.com/s/atkinsonhyperlegible/v10/9Bt23C1KxNDXMspQ1lPyU89-1h6ONRlW45G04pIo.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/feed.xml rel=alternate type=application/atom+xml title="Alex Saveau"><title>Fast Unix Commands | Alex Saveau</title><meta content="Jekyll v4.3.2" name=generator><meta content="Fast Unix Commands" property=og:title><meta content="Alex Saveau" name=author><meta content=en_US property=og:locale><meta content="Fast Unix Commands (FUC) is a project that aims to create the world’s fastest Unix commands. Currently, this means rm and cp replacements named rmz and cpz (the ‘z’ stands for “zippy”). When better performance cannot be achieved, the next highest priority is efficiency. In practice, rmz appears to be the fastest file deleter available while cpz wins in most cases, only losing in flat directory hierarchies." name=description><meta content="Fast Unix Commands (FUC) is a project that aims to create the world’s fastest Unix commands. Currently, this means rm and cp replacements named rmz and cpz (the ‘z’ stands for “zippy”). When better performance cannot be achieved, the next highest priority is efficiency. In practice, rmz appears to be the fastest file deleter available while cpz wins in most cases, only losing in flat directory hierarchies." property=og:description><link href=https://alexsaveau.dev/blog/projects/performance/files/fuc/fast-unix-commands rel=canonical><meta content=https://alexsaveau.dev/blog/projects/performance/files/fuc/fast-unix-commands property=og:url><meta content="Alex Saveau" property=og:site_name><meta content=https://alexsaveau.dev/assets/resized/me2-800-min.jpg property=og:image><meta content=article property=og:type><meta content=2023-03-24T00:00:00+00:00 property=article:published_time><meta content=summary_large_image name=twitter:card><meta content=https://alexsaveau.dev/assets/resized/me2-800-min.jpg property=twitter:image><meta content="Fast Unix Commands" property=twitter:title><meta content=@SUPERCILEX name=twitter:site><meta content=@SUPERCILEX name=twitter:creator><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Saveau"},"dateModified":"2024-01-23T00:53:55+00:00","datePublished":"2023-03-24T00:00:00+00:00","description":"Fast Unix Commands (FUC) is a project that aims to create the world’s fastest Unix commands. Currently, this means rm and cp replacements named rmz and cpz (the ‘z’ stands for “zippy”). When better performance cannot be achieved, the next highest priority is efficiency. In practice, rmz appears to be the fastest file deleter available while cpz wins in most cases, only losing in flat directory hierarchies.","headline":"Fast Unix Commands","image":"https://alexsaveau.dev/assets/resized/me2-800-min.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://alexsaveau.dev/blog/projects/performance/files/fuc/fast-unix-commands"},"url":"https://alexsaveau.dev/blog/projects/performance/files/fuc/fast-unix-commands"}</script><script>window.addEventListener("DOMContentLoaded",()=>{for(let e of document.querySelectorAll(".loads")){var o=()=>{e.classList.remove("loads")};e.complete?o():(e.onload=o,e.onerror=o)}})</script><noscript><style>.loads{animation:none!important;background-color:unset!important}</style></noscript><link href=//fonts.gstatic.com/s/firacode/v17/uU9NCBsR6Z2vfE9aq3bh3dSD.woff2 rel=preload type=font/woff2 as=font crossorigin><style>@keyframes tooltip-appear{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.33}}:root{--progress-color:gray;--blockquote-color:#6a737d;--blockquote-boarder-color:#959da5;--code-background-color:rgba(0, 0, 0, 0.05);--hr-color:gray;--footer-color:white;--loading-pulse-color:#b0b0b0}@font-face{font-family:"Fira Code";font-style:normal;font-weight:475;font-display:swap;src:url(//fonts.gstatic.com/s/firacode/v17/uU9NCBsR6Z2vfE9aq3bh3dSD.woff2) format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}.article{overflow-wrap:break-word}.article .highlight{background-color:rgba(0,0,0,.04);border-radius:3px}.article h2,.article h3{margin:1.5em 0-.5em}.article h2{font-size:1.875rem}.article h3{font-size:1.5rem}.article p{font-size:1.313rem;margin:.95em 0 1.2em}.article code{font-family:"Fira Code",monospace;font-size:1rem;background-color:var(--code-background-color);border-radius:3px;padding:2px 4px}.article div pre{padding:20px}.article div pre code,a{background-color:transparent}.article div pre code{padding:0}.article ul{font-size:1.313rem;padding-left:32px;margin-bottom:16px}.header-link{visibility:hidden}h2:hover .header-link,h3:hover .header-link{visibility:visible}.octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";line-height:1.5;color:#24292e;background-color:#fff;font-family:Atkinson Hyperlegible,sans-serif;font-size:1em}footer{display:block;display:flex;padding:5px;align-items:center;background-color:var(--footer-color)}a{color:#0366d6;text-decoration:none}a:active,a:hover{outline-width:0}h1{margin:.67em 0}small{font-size:90%}img{border-style:none}svg:not(:root){overflow:hidden}hr{box-sizing:content-box;height:0;margin:15px 0;overflow:hidden;background:0 0;border:0;border-bottom:1px solid #dfe2e5;border:1.5px solid var(--hr-color);border-radius:1.5px;background-color:var(--hr-color)}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*{box-sizing:border-box}a:hover{text-decoration:underline}hr::after,hr::before{display:table;content:""}hr::after{clear:both}h1,h2,h3,p,pre,ul{margin-top:0;margin-bottom:0}h1,h2,h3{font-size:2rem;font-weight:600}h2,h3{font-size:1.5rem}h3{font-size:1.25rem}p{margin-bottom:10px}ul{padding-left:0}code,pre{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;font-size:.75rem}:-ms-input-placeholder{color:#6a737d;opacity:1}::-ms-input-placeholder{color:#6a737d;opacity:1}:checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}@media (min-width:768px){.col-md-5{width:41.66667%}.col-md-7{width:58.33333%}}@media (min-width:1012px){.col-lg-4{width:33.33333%}.col-lg-8{width:66.66667%}}@media (min-width:1280px){.col-xl-3{width:25%}.col-xl-9{width:75%}}.tooltipped{position:relative}.tooltipped::after,.tooltipped::before{position:absolute;display:none;pointer-events:none;opacity:0}.tooltipped::after{z-index:1000000;padding:.5em .75em;font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";-webkit-font-smoothing:subpixel-antialiased;color:#fff;text-align:center;text-decoration:none;text-shadow:none;text-transform:none;letter-spacing:normal;word-wrap:break-word;white-space:pre;content:attr(aria-label);background:#1b1f23;border-radius:6px}.tooltipped::before{z-index:1000001;width:0;height:0;color:#1b1f23;content:"";border:6px solid transparent}.tooltipped:active::after,.tooltipped:active::before,.tooltipped:focus::after,.tooltipped:focus::before,.tooltipped:hover::after,.tooltipped:hover::before{display:inline-block;text-decoration:none;animation-name:tooltip-appear;animation-duration:.1s;animation-fill-mode:forwards;animation-timing-function:ease-in;animation-delay:.4s}.tooltipped-se::after{top:100%;margin-top:6px}.tooltipped-se::before{top:auto;right:50%;bottom:-7px;margin-right:-6px;border-bottom-color:#1b1f23}.tooltipped-se::after{right:auto;left:50%;margin-left:-16px}.border-top{border-top:1px solid #e1e4e8!important}@media (min-width:768px){.border-md-right{border-right:1px solid #e1e4e8!important}.border-md-bottom{border-bottom:1px solid #e1e4e8!important}.border-md-top-0{border-top:0!important}}.circle{border-radius:50%!important}.border-gray-light{border-color:#eaecef!important}.bg-white{background-color:#fff!important}.bg-gray-light{background-color:#fafbfc!important}.text-gray{color:#586069!important}.flex-wrap{flex-wrap:wrap!important}.flex-items-start{align-items:flex-start!important}.flex-items-center{align-items:center!important}.flex-self-stretch{align-self:stretch!important}.v-align-middle{vertical-align:middle!important}.mr-2{margin-right:8px!important}.mx-auto{margin-right:auto!important;margin-left:auto!important}.px-4{padding-right:24px!important;padding-left:24px!important}.f4{font-size:1rem!important}@media (min-width:768px){.px-md-6{padding-right:40px!important;padding-left:40px!important}.f4{font-size:1rem!important}}.f5{font-size:.875rem!important}.f00-light{font-size:2.5rem!important;font-weight:300!important}@media (min-width:768px){.f00-light{font-size:3rem!important}}.f2-light{font-size:1.375rem!important;font-weight:300!important}.lh-condensed{line-height:1.25!important}.d-flex{display:flex!important}.d-none{display:none!important}@font-face{font-family:Inter;font-style:normal;font-weight:400;src:local("Inter"),local("Inter-Regular"),url(/fonts/Inter-Regular.woff) format("woff");font-display:swap}@font-face{font-family:Inter;font-style:normal;font-weight:500;src:local("Inter Medium"),local("Inter-Medium"),url(/fonts/Inter-Medium.woff) format("woff");font-display:swap}@font-face{font-family:Inter;font-style:normal;font-weight:600;src:local("Inter Bold"),local("Inter-Bold"),url(/fonts/Inter-Bold.woff) format("woff");font-display:swap}.mb-2{margin-bottom:8px!important}.mb-3{margin-bottom:16px!important}.mb-5{margin-bottom:32px!important}.mb-6{margin-bottom:40px!important}.py-6{padding-top:40px!important;padding-bottom:40px!important}.highlight{width:100%;overflow:auto;background:#fff}.highlight .k,.highlight .o{font-weight:700}.highlight .cm{color:#998;font-style:italic}.highlight .s{color:#d14}.highlight .nb{color:#0086b3}.highlight .nf{color:#900;font-weight:700}.highlight .nn{color:#555}.highlight .ow{font-weight:700}.highlight .mi{color:#099}@font-face{font-family:"Atkinson Hyperlegible";font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/atkinsonhyperlegible/v10/9Bt23C1KxNDXMspQ1lPyU89-1h6ONRlW45G04pIo.woff2) format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}footer small{width:100%}footer small:last-child{text-align:end}.min-height-full{min-height:100vh}.icon-color{fill:#24292e!important}.loads{animation-duration:2s;animation:2s cubic-bezier(.4,0,.6,1) infinite pulse;animation-timing-function:cubic-bezier(.4,0,.6,1);animation-iteration-count:infinite;animation-name:pulse;background-color:var(--loading-pulse-color)}@media (min-width:768px){.f2-light{font-size:1.5rem!important}.d-md-flex{display:flex!important}#masthead{position:fixed;width:min-content}.masthead-name-mobile{display:none}}@media (max-width:768px){.masthead-mini{padding-top:10px!important;padding-bottom:10px!important}.masthead-mini-container{display:flex;align-items:center}.masthead-profile{width:80px;height:80px;margin-bottom:0!important}.masthead-intro{padding-left:24px}.masthead-name{display:none}.masthead-bio{margin-bottom:0!important}.masthead-metadata{display:none}}@media (min-width:1942px){.masthead{max-width:400px}.content-container{width:100%}}@media (prefers-color-scheme:dark){:root{--progress-color:whitesmoke;--blockquote-color:#dadada;--blockquote-boarder-color:#dadada;--code-background-color:rgba(255,255,255,0.15);--hr-color:whitesmoke;--footer-color:black;--loading-pulse-color:#383838}.article p{color:#ededed}.highlight pre{background-color:#272822}.highlight .k{color:#66d9ef}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .cm{color:#b4aa77}.highlight .s{color:#e6db74}.highlight .nb{color:#f8f8f2}.highlight .nd,.highlight .nf{color:#a6e22e}.highlight .nn,.highlight .py{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .mi{color:#ae81ff}a{color:unset!important;text-decoration:underline}.bg-white{background-color:#4f565d!important}.bg-gray-light{background-color:#2f363d!important}.border-gray-light{border-color:transparent!important}.text-gray{color:#d0d8e1!important}.border-md-bottom{border:0!important}.masthead{background-color:#24292e!important}.scoped-text-defaults,.text-defaults,.text-defaults *{color:#fff!important}.icon-color{fill:#fff!important}}</style><body class=min-height-full id=top><div class="min-height-full bg-gray-light border-md-bottom d-md-flex"><div class="px-4 px-lg-7 py-6 bg-white border-gray-light border-md-right col-lg-4 col-md-5 col-xl-3 flex-self-stretch masthead masthead-mini px-md-6"><div class=masthead-mini-container id=masthead><a href=/ ><picture><source sizes=150px srcset="/assets/resized/me2-240-min.avif 240w, /assets/resized/me2-320-min.avif 320w, /assets/resized/me2-480-min.avif 480w, /assets/resized/me2-800-min.avif 800w, /assets/resized/me2-min.avif 1528w" type=image/avif><source sizes=150px srcset="/assets/resized/me2-240-min.webp 240w, /assets/resized/me2-320-min.webp 320w, /assets/resized/me2-480-min.webp 480w, /assets/resized/me2-800-min.webp 800w, /assets/resized/me2-min.webp 1528w" type=image/webp><source sizes=150px srcset="/assets/resized/me2-240-min.jpg 240w, /assets/resized/me2-320-min.jpg 320w, /assets/resized/me2-480-min.jpg 480w, /assets/resized/me2-800-min.jpg 800w, /assets/resized/me2-min.jpg 1528w" type=image/jpeg><source sizes=150px srcset="/assets/resized/me2-240.jpg 240w, /assets/resized/me2-320.jpg 320w, /assets/resized/me2-480.jpg 480w, /assets/resized/me2-800.jpg 800w, /assets/me2.jpg 1528w"><img alt="Profile Picture" class="mb-3 circle loads masthead-profile" height=150 loading=lazy src=/assets/resized/me2-240.jpg width=150></picture></a><div class=masthead-intro><h1 class="text-defaults lh-condensed mb-2 masthead-name">Alex Saveau</h1><h2 class="text-defaults lh-condensed mb-2 masthead-name-mobile">Alex Saveau</h2><p class="mb-3 f4 masthead-bio text-gray" id=bio>Relentless efficiency</div><div class="f4 masthead-metadata"><div class="text-defaults d-flex flex-items-center mb-3"><svg height=20 viewBox="0 0 16 16" aria-label=GitHub class="icon-color mr-2 octicon v-align-middle octicon-mark-github" role=img version=1.1 width=20><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg> <a href=//github.com/SUPERCILEX>@SUPERCILEX</a></div><div class="text-defaults d-flex flex-items-center mb-3"><svg height=20 viewBox="0 0 16 16" aria-label=email class="icon-color mr-2 octicon v-align-middle octicon-mail" role=img version=1.1 width=20><path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"></path></svg> <a href=mailto:saveau.alexandre@gmail.com>saveau.alexandre@gmail.com</a></div><div class="flex-items-start d-flex flex-wrap"><div class=mb-3><a href=//stackoverflow.com/u/4548500 class="tooltipped tooltipped-se" aria-label="Stack Overflow: 4548500"><svg height=24 viewBox="0 0 120 120" fill=#959da5 xmlns=http://www.w3.org/2000/svg><path d="M84.4 93.8V70.6h7.7v30.9H22.6V70.6h7.7v23.2z" class=st0 /><path d="M38.8 68.4l37.8 7.9 1.6-7.6-37.8-7.9-1.6 7.6zm5-18l35 16.3 3.2-7-35-16.4-3.2 7.1zm9.7-17.2l29.7 24.7 4.9-5.9-29.7-24.7-4.9 5.9zm19.2-18.3l-6.2 4.6 23 31 6.2-4.6-23-31zM38 86h38.6v-7.7H38V86z" class=st1 /></svg><span class=d-none>Stack Overflow</span></a></div></div></div></div></div><div class="px-4 px-lg-7 py-6 border-md-top-0 border-top col-lg-8 col-md-7 col-xl-9 content-container" id=article><div class=mx-auto style=max-width:900px><div class="f4 mb-6"><div class="f4 scoped-text-defaults"><p class=f5><a href=/blog class="text-defaults d-flex flex-items-center"><svg height=16 viewBox="0 0 16 16" aria-label=include.parent class="icon-color mr-2 octicon v-align-middle octicon-chevron-left" role=img version=1.1 width=16><path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z"></path></svg>Blog</a><h1 class="text-defaults lh-condensed f00-light" style=font-weight:600!important>Fast Unix Commands</h1><h2 class="lh-condensed f2-light text-gray" style=font-weight:400!important>The world's fastest rm command and one of the fastest cp commands</h2><p class="mb-5 text-gray">Published Mar 24, 2023 • Last updated Jan 23, 2024 • 3 min read<div class=article><p><a href=//github.com/SUPERCILEX/fuc>Fast Unix Commands</a> (FUC) is a project that aims to create the world’s fastest Unix commands. Currently, this means <code class="highlighter-rouge language-plaintext">rm</code> and <code class="highlighter-rouge language-plaintext">cp</code> replacements named <code class="highlighter-rouge language-plaintext">rmz</code> and <code class="highlighter-rouge language-plaintext">cpz</code> (the ‘z’ stands for “zippy”). When better performance cannot be achieved, the next highest priority is efficiency. In practice, <code class="highlighter-rouge language-plaintext">rmz</code> appears to be the fastest file deleter available while <code class="highlighter-rouge language-plaintext">cpz</code> wins in most cases, only losing in flat directory hierarchies.<h2 id=myth-busting>Myth busting <a href=#myth-busting class=header-link>#</a></h2><p>Many Stack Overflow answers will tell you to use this or that as a faster alternative to <code class="highlighter-rouge language-plaintext">rm</code> or <code class="highlighter-rouge language-plaintext">cp</code>. Let’s look at the <a href=//github.com/SUPERCILEX/fuc/tree/master/comparisons>data</a>!<h3 id=rsync>Rsync <a href=#rsync class=header-link>#</a></h3><p>Using <code class="highlighter-rouge language-plaintext">rsync</code> for copying is always slower than <code class="highlighter-rouge language-plaintext">cp</code> as far as I can tell. This should not come as a surprise given that it performs data integrity checks. Interestingly enough, <code class="highlighter-rouge language-plaintext">rsync</code> deletes very large directories faster than <code class="highlighter-rouge language-plaintext">rm</code>, but is slower in all other cases.<h3 id=find>Find <a href=#find class=header-link>#</a></h3><p><code class="highlighter-rouge language-plaintext">find</code> and <code class="highlighter-rouge language-plaintext">rm</code> are approximately equivalent in terms of performance.<h3 id=tar>Tar <a href=#tar class=header-link>#</a></h3><p>Shockingly, collecting a directory into a tarball and then extracting it into a new directory to copy it is often faster than <code class="highlighter-rouge language-plaintext">cp</code>.<h2 id=ecosystem-contributions>Ecosystem contributions <a href=#ecosystem-contributions class=header-link>#</a></h2><p>This project lead to some notable Rust ecosystem contributions:<ul><li>Discovering that <code class="highlighter-rouge language-plaintext">MaybeUninit</code> arrays accidentally <a href=//github.com/rust-lang/rust/issues/96274>memset their contents</a>.<li>Improving the stdlib to <a href=//github.com/rust-lang/rust/pull/93668>avoid allocations</a> (in <a href=//github.com/nix-rust/nix/pull/1655>nix</a> and <a href=//github.com/bytecodealliance/rustix/pull/448>rustix</a> too).<li>Adding APIs for <a href=//github.com/bytecodealliance/rustix/pull/457>raw directory iteration</a> in rustix.<li>Writing a tool that <a href=/blog/ftzz>generates reproducible file trees</a> for benchmarking purposes.</ul><h2 id=technical-overview>Technical overview <a href=#technical-overview class=header-link>#</a></h2><p>Both tools are built using the same scheduling algorithm, following similar principles to <a href=/blog/ftzz#scheduling-algorithm>FTZZ’s scheduler</a>. The key insight is that file operations in separate directories don’t (for the most part) interfere with each other, enabling parallel execution. The intuition here is that directories are a shared resource for their direct children and must therefore serialize concurrent directory-modifying operations, causing <a href=#contention>contention</a>. In brief, file creation or deletion cannot occur at the same time within one directory. Thus, the goal is to schedule one task per directory and execute each task in parallel.<p>Doing this for copies is relatively easy: iterate through every directory, spawn a new task when a directory is encountered and copy files in place. File removal is far more interesting because you cannot remove a directory until all of its children (including subdirectories) have been fully removed. As a consequence, file removal tasks must wait until their children have completed before finally removing the current directory. Unfortunately, this approach is slow: memory and time must be spent keeping track of child tasks, and children must somehow notify their parents of completion.<p>Flipping the problem on its head reveals a beautiful solution: what if children were in charge of deleting their parents? With a little bit of atomic reference counting, this solution is straightforward to implement and comes at almost no additional cost. While traversing directories, each spawned child directory task includes a parent (smart) pointer, implicitly creating a dynamic tree structure that models the directory hierarchy. These parent pointers are reference counted and trigger the directory deletion when fully freed. Additionally, each task decrements its reference count upon completion. That’s it! Now, regardless of whether a parent finishes after all of its children or vice versa, the last “user” of a directory will delete its directory chain.<p>Pseudocode might make this clearer:<div class="highlighter-rouge language-python"><div class=highlight><pre class=highlight><code><span class=k>def</span> <span class=nf>delete_dir</span><span class=p>(</span><span class=n>node</span> <span class=o>@</span> <span class=n>Node</span> <span class=p>{</span> <span class=nb>dir</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=n>ref_count</span> <span class=p>},</span> <span class=n>task_queue</span><span class=p>):</span>
    <span class=k>for</span> <span class=nb>file</span> <span class=ow>in</span> <span class=nb>dir</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>file</span> <span class=ow>is</span> <span class=nb>dir</span><span class=p>:</span>
            <span class=n>ref_count</span><span class=o>++</span>
            <span class=n>task_queue</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=n>new</span> <span class=n>Node</span> <span class=p>{</span> <span class=nb>dir</span><span class=p>:</span> <span class=nb>file</span><span class=p>,</span> <span class=n>parent</span><span class=p>:</span> <span class=n>node</span><span class=p>,</span> <span class=n>ref_count</span><span class=p>:</span> <span class=mi>1</span> <span class=p>})</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>file</span><span class=p>.</span><span class=n>delete</span><span class=p>()</span>

    <span class=n>ref_count</span><span class=o>--</span>
    <span class=k>while</span> <span class=n>node</span><span class=p>.</span><span class=n>ref_count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>node</span><span class=p>.</span><span class=nb>dir</span><span class=p>.</span><span class=n>delete</span><span class=p>()</span>
        <span class=n>node</span> <span class=o>=</span> <span class=n>node</span><span class=p>.</span><span class=n>parent</span>
        <span class=n>node</span><span class=p>.</span><span class=n>ref_count</span><span class=o>--</span>
</code></pre></div></div><hr><p>Enjoy blazing fast copies and deletions! 🚀<h2 id=contention>Appendix—directory contention benchmark <a href=#contention class=header-link>#</a></h2><p><div class="highlighter-rouge language-rust"><div class=highlight><pre class=highlight><code><span class=cm>/*
This benchmark creates and then deletes ~16K files in N directories with two possible methods:
zip=every thread creates/deletes its own directory
chain=every thread creates/deletes a sub-set of the directory, one directory at a time

$ cargo b --release
$ cp target/release/test test
$ hyperfine --warmup 3 -N "./test /var/tmp 8 zip" "./test /var/tmp 8 chain"
Benchmark 1: ./test /var/tmp 8 zip
  Time (mean ± σ):     528.5 ms ±  11.5 ms    [User: 131.0 ms, System: 3460.0 ms]
  Range (min … max):   518.6 ms … 553.2 ms    10 runs

Benchmark 2: ./test /var/tmp 8 chain
  Time (mean ± σ):      1.488 s ±  0.140 s    [User: 0.143 s, System: 7.991 s]
  Range (min … max):    1.297 s …  1.659 s    10 runs

Summary
  './test /var/tmp 8 zip' ran
    2.82 ± 0.27 times faster than './test /var/tmp 8 chain'
*/</span>

<span class=k>use</span> <span class=nn>std</span><span class=p>::{</span>
    <span class=n>env</span><span class=p>,</span>
    <span class=nn>fs</span><span class=p>::{</span><span class=n>create_dir</span><span class=p>,</span> <span class=n>remove_dir</span><span class=p>,</span> <span class=n>remove_file</span><span class=p>,</span> <span class=n>File</span><span class=p>},</span>
    <span class=n>io</span><span class=p>,</span>
    <span class=nn>path</span><span class=p>::</span><span class=n>PathBuf</span><span class=p>,</span>
    <span class=n>thread</span><span class=p>,</span>
<span class=p>};</span>

<span class=k>const</span> <span class=n>FILES</span><span class=p>:</span> <span class=nb>usize</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>14</span><span class=p>;</span>

<span class=k>fn</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>let</span> <span class=n>arg</span> <span class=o>=</span> <span class=p>|</span><span class=n>n</span><span class=p>|</span> <span class=nn>env</span><span class=p>::</span><span class=nf>args</span><span class=p>()</span><span class=nf>.nth</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=nf>.unwrap</span><span class=p>();</span>
    <span class=k>let</span> <span class=n>root</span> <span class=o>=</span> <span class=nn>PathBuf</span><span class=p>::</span><span class=nf>from</span><span class=p>(</span><span class=nf>arg</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
    <span class=k>let</span> <span class=n>n</span><span class=p>:</span> <span class=nb>usize</span> <span class=o>=</span> <span class=nf>arg</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=nf>.parse</span><span class=p>()</span><span class=nf>.unwrap</span><span class=p>();</span>
    <span class=k>let</span> <span class=n>method</span> <span class=o>=</span> <span class=nf>arg</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>

    <span class=k>let</span> <span class=n>dirs</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=o>..</span><span class=n>n</span><span class=p>)</span>
        <span class=nf>.map</span><span class=p>(|</span><span class=n>i</span><span class=p>|</span> <span class=p>{</span>
            <span class=k>let</span> <span class=n>dir</span> <span class=o>=</span> <span class=n>root</span><span class=nf>.join</span><span class=p>(</span><span class=nd>format!</span><span class=p>(</span><span class=s>"test{i}"</span><span class=p>));</span>
            <span class=nf>create_dir</span><span class=p>(</span><span class=o>&</span><span class=n>dir</span><span class=p>)</span><span class=nf>.unwrap</span><span class=p>();</span>
            <span class=n>dir</span>
        <span class=p>})</span>
        <span class=py>.collect</span><span class=p>::</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>_</span><span class=o>>></span><span class=p>();</span>

    <span class=k>let</span> <span class=n>run</span> <span class=o>=</span> <span class=p>{</span>
        <span class=nd>assert_eq!</span><span class=p>(</span><span class=n>FILES</span> <span class=o>%</span> <span class=n>n</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=k>let</span> <span class=n>batch_size</span> <span class=o>=</span> <span class=n>FILES</span> <span class=o>/</span> <span class=n>n</span><span class=p>;</span>

        <span class=k>let</span> <span class=n>dirs</span> <span class=o>=</span> <span class=n>dirs</span><span class=nf>.clone</span><span class=p>();</span>
        <span class=k>move</span> <span class=p>|</span><span class=n>op</span><span class=p>:</span> <span class=k>fn</span><span class=p>(</span><span class=n>PathBuf</span><span class=p>)</span> <span class=k>-></span> <span class=nn>io</span><span class=p>::</span><span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>></span><span class=p>,</span> <span class=n>id</span><span class=p>:</span> <span class=nb>usize</span><span class=p>|</span> <span class=k>match</span> <span class=o>&*</span><span class=n>method</span> <span class=p>{</span>
            <span class=s>"zip"</span> <span class=k>=></span> <span class=p>{</span>
                <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mi>0</span><span class=o>..</span><span class=n>FILES</span> <span class=p>{</span>
                    <span class=nf>op</span><span class=p>(</span><span class=n>dirs</span><span class=p>[</span><span class=n>id</span><span class=p>]</span><span class=nf>.join</span><span class=p>(</span><span class=nd>format!</span><span class=p>(</span><span class=s>"f{i}"</span><span class=p>)))</span><span class=nf>.unwrap</span><span class=p>();</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=s>"chain"</span> <span class=k>=></span> <span class=p>{</span>
                <span class=k>for</span> <span class=n>dir</span> <span class=k>in</span> <span class=n>dirs</span> <span class=p>{</span>
                    <span class=k>let</span> <span class=n>start</span> <span class=o>=</span> <span class=n>batch_size</span> <span class=o>*</span> <span class=n>id</span><span class=p>;</span>
                    <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>start</span><span class=o>..</span><span class=p>(</span><span class=n>start</span> <span class=o>+</span> <span class=n>batch_size</span><span class=p>)</span> <span class=p>{</span>
                        <span class=nf>op</span><span class=p>(</span><span class=n>dir</span><span class=nf>.join</span><span class=p>(</span><span class=nd>format!</span><span class=p>(</span><span class=s>"f{i}"</span><span class=p>)))</span><span class=nf>.unwrap</span><span class=p>();</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=n>_</span> <span class=k>=></span> <span class=p>{</span>
                <span class=nd>unreachable!</span><span class=p>()</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>};</span>
    <span class=k>let</span> <span class=n>bench</span> <span class=o>=</span> <span class=p>|</span><span class=n>op</span><span class=p>|</span> <span class=p>{</span>
        <span class=p>(</span><span class=mi>0</span><span class=o>..</span><span class=n>n</span><span class=p>)</span>
            <span class=nf>.map</span><span class=p>(|</span><span class=n>id</span><span class=p>|</span> <span class=p>{</span>
                <span class=nn>thread</span><span class=p>::</span><span class=nf>spawn</span><span class=p>({</span>
                    <span class=k>let</span> <span class=n>run</span> <span class=o>=</span> <span class=n>run</span><span class=nf>.clone</span><span class=p>();</span>
                    <span class=k>move</span> <span class=p>||</span> <span class=nf>run</span><span class=p>(</span><span class=n>op</span><span class=p>,</span> <span class=n>id</span><span class=p>)</span>
                <span class=p>})</span>
            <span class=p>})</span>
            <span class=py>.collect</span><span class=p>::</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>_</span><span class=o>>></span><span class=p>()</span>
            <span class=nf>.into_iter</span><span class=p>()</span>
            <span class=nf>.map</span><span class=p>(|</span><span class=n>task</span><span class=p>|</span> <span class=n>task</span><span class=nf>.join</span><span class=p>()</span><span class=nf>.unwrap</span><span class=p>())</span>
            <span class=nf>.for_each</span><span class=p>(</span><span class=nb>drop</span><span class=p>);</span>
    <span class=p>};</span>

    <span class=nf>bench</span><span class=p>(|</span><span class=n>arg</span><span class=p>|</span> <span class=nn>File</span><span class=p>::</span><span class=nf>create</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=nf>.map</span><span class=p>(</span><span class=nb>drop</span><span class=p>));</span>
    <span class=nf>bench</span><span class=p>(</span><span class=n>remove_file</span><span class=p>);</span>

    <span class=k>for</span> <span class=n>dir</span> <span class=k>in</span> <span class=n>dirs</span> <span class=p>{</span>
        <span class=nf>remove_dir</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span><span class=nf>.unwrap</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></div></div></div></div></div></div></div><footer class=text-defaults><small>Copyright © 2018-2025 Alex Saveau</small> <small><a href=//github.com/SUPERCILEX/personal-website>Source</a> | <a href=//twitter.com/SUPERCILEX>Twitter</a> | <a href=#top>Back to top</a></small></footer>