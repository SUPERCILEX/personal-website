<!doctype html><html class=min-height-full lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="light dark" name=color-scheme><link href=/favicon.ico rel=icon type=image/x-icon><link href=//fonts.gstatic.com/s/atkinsonhyperlegible/v10/9Bt23C1KxNDXMspQ1lPyU89-1h6ONRlW45G04pIo.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/feed.xml rel=alternate type=application/atom+xml title="Alex Saveau"><title>Advanced Kotlin Coroutines tips and tricks | Alex Saveau</title><meta content="Jekyll v4.3.2" name=generator><meta content="Advanced Kotlin Coroutines tips and tricks" property=og:title><meta content="Alex Saveau" name=author><meta content=en_US property=og:locale><meta content="Kotlin Coroutines starts off incredibly simple: just put some long running operation in launch and you‚Äôre good, right? For simple cases, sure. But pretty soon, the complexity inherent to concurrency and parallelism starts piling up." name=description><meta content="Kotlin Coroutines starts off incredibly simple: just put some long running operation in launch and you‚Äôre good, right? For simple cases, sure. But pretty soon, the complexity inherent to concurrency and parallelism starts piling up." property=og:description><link href=https://alexsaveau.dev/blog/kotlin/android/advanced-kotlin-coroutines-tips-and-tricks rel=canonical><meta content=https://alexsaveau.dev/blog/kotlin/android/advanced-kotlin-coroutines-tips-and-tricks property=og:url><meta content="Alex Saveau" property=og:site_name><meta content=https://alexsaveau.dev/assets/resized/kotlin/kotlin-banner-800-min.jpg property=og:image><meta content=article property=og:type><meta content=2018-10-30T00:00:00+00:00 property=article:published_time><meta content=summary_large_image name=twitter:card><meta content=https://alexsaveau.dev/assets/resized/kotlin/kotlin-banner-800-min.jpg property=twitter:image><meta content="Advanced Kotlin Coroutines tips and tricks" property=twitter:title><meta content=@SUPERCILEX name=twitter:site><meta content=@SUPERCILEX name=twitter:creator><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Saveau"},"dateModified":"2020-06-17T22:29:04+00:00","datePublished":"2018-10-30T00:00:00+00:00","description":"Kotlin Coroutines starts off incredibly simple: just put some long running operation in launch and you‚Äôre good, right? For simple cases, sure. But pretty soon, the complexity inherent to concurrency and parallelism starts piling up.","headline":"Advanced Kotlin Coroutines tips and tricks","image":"https://alexsaveau.dev/assets/resized/kotlin/kotlin-banner-800-min.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://alexsaveau.dev/blog/kotlin/android/advanced-kotlin-coroutines-tips-and-tricks"},"url":"https://alexsaveau.dev/blog/kotlin/android/advanced-kotlin-coroutines-tips-and-tricks"}</script><script>window.addEventListener("DOMContentLoaded",()=>{for(let e of document.querySelectorAll(".loads")){var o=()=>{e.classList.remove("loads")};e.complete?o():(e.onload=o,e.onerror=o)}})</script><noscript><style>.loads{animation:none!important;background-color:unset!important}</style></noscript><link href=//fonts.gstatic.com/s/firacode/v17/uU9NCBsR6Z2vfE9aq3bh3dSD.woff2 rel=preload type=font/woff2 as=font crossorigin><style>@keyframes tooltip-appear{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.33}}:root{--progress-color:gray;--blockquote-color:#6a737d;--blockquote-boarder-color:#959da5;--code-background-color:rgba(0, 0, 0, 0.05);--hr-color:gray;--footer-color:white;--loading-pulse-color:#b0b0b0}@font-face{font-family:"Fira Code";font-style:normal;font-weight:475;font-display:swap;src:url(//fonts.gstatic.com/s/firacode/v17/uU9NCBsR6Z2vfE9aq3bh3dSD.woff2) format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}.article{overflow-wrap:break-word}.article .caption{font-size:1rem;margin:-1.5em 0 0}.article .gist-caption{font-size:1rem;margin:-.5em 0 0}.article h2,.article h3{margin:1.5em 0-.5em}.article h2{font-size:1.875rem}.article h2 code{font-size:1.625rem}.article h3{font-size:1.5rem}.article h3 code,.article strong{font-size:1.25rem}.article p{font-size:1.313rem;margin:.95em 0 1.2em}.article p.caption{text-align:center}.article img.article-image{width:100%;height:auto}.article code{font-family:"Fira Code",monospace;font-size:1rem;background-color:var(--code-background-color);border-radius:3px;padding:2px 4px}.article blockquote{border-left:4px solid var(--blockquote-boarder-color);padding-left:16px;margin-bottom:16px;margin-left:0;margin-right:0}.article blockquote :not(a){color:var(--blockquote-color)}.article ol,.article ul{font-size:1.313rem;padding-left:32px;margin-bottom:16px}.header-link{visibility:hidden}h2:hover .header-link,h3:hover .header-link{visibility:visible}@media (prefers-color-scheme:dark){:root{--progress-color:whitesmoke;--blockquote-color:#dadada;--blockquote-boarder-color:#dadada;--code-background-color:rgba(255,255,255,0.15)}.article .caption,.article .gist-caption{color:#dadada}.article p{color:#ededed}.article img:not([src*=".svg"]){filter:brightness(.8) contrast(1.1)}}.octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";line-height:1.5;color:#24292e;background-color:#fff;font-family:Atkinson Hyperlegible,sans-serif;font-size:1em}footer{display:block;display:flex;padding:5px;align-items:center;background-color:var(--footer-color)}a{background-color:transparent;color:#0366d6;text-decoration:none}a:active,a:hover{outline-width:0}strong{font-weight:600}h1{margin:.67em 0}small{font-size:90%}img{border-style:none}svg:not(:root){overflow:hidden}hr{box-sizing:content-box;height:0;margin:15px 0;overflow:hidden;background:0 0;border:0;border-bottom:1px solid #dfe2e5;border:1.5px solid var(--hr-color);border-radius:1.5px;background-color:var(--hr-color)}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*{box-sizing:border-box}a:hover{text-decoration:underline}hr::after,hr::before{display:table;content:""}hr::after{clear:both}h1,h2,h3,ol,p,pre,ul{margin-top:0;margin-bottom:0}h1,h2,h3{font-size:2rem;font-weight:600}h2,h3{font-size:1.5rem}h3{font-size:1.25rem}p{margin-bottom:10px}blockquote{margin:0}ol,ul{padding-left:0}code,pre{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;font-size:.75rem}:-ms-input-placeholder{color:#6a737d;opacity:1}::-ms-input-placeholder{color:#6a737d;opacity:1}:checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}@media (min-width:768px){.col-md-5{width:41.66667%}.col-md-7{width:58.33333%}}@media (min-width:1012px){.col-lg-4{width:33.33333%}.col-lg-8{width:66.66667%}}@media (min-width:1280px){.col-xl-3{width:25%}.col-xl-9{width:75%}}.tooltipped{position:relative}.tooltipped::after,.tooltipped::before{position:absolute;display:none;pointer-events:none;opacity:0}.tooltipped::after{z-index:1000000;padding:.5em .75em;font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";-webkit-font-smoothing:subpixel-antialiased;color:#fff;text-align:center;text-decoration:none;text-shadow:none;text-transform:none;letter-spacing:normal;word-wrap:break-word;white-space:pre;content:attr(aria-label);background:#1b1f23;border-radius:6px}.tooltipped::before{z-index:1000001;width:0;height:0;color:#1b1f23;content:"";border:6px solid transparent}.tooltipped:active::after,.tooltipped:active::before,.tooltipped:focus::after,.tooltipped:focus::before,.tooltipped:hover::after,.tooltipped:hover::before{display:inline-block;text-decoration:none;animation-name:tooltip-appear;animation-duration:.1s;animation-fill-mode:forwards;animation-timing-function:ease-in;animation-delay:.4s}.tooltipped-se::after{top:100%;margin-top:6px}.tooltipped-se::before{top:auto;right:50%;bottom:-7px;margin-right:-6px;border-bottom-color:#1b1f23}.tooltipped-se::after{right:auto;left:50%;margin-left:-16px}.border-top{border-top:1px solid #e1e4e8!important}@media (min-width:768px){.border-md-right{border-right:1px solid #e1e4e8!important}.border-md-bottom{border-bottom:1px solid #e1e4e8!important}.border-md-top-0{border-top:0!important}}.circle{border-radius:50%!important}.border-gray-light{border-color:#eaecef!important}.bg-white{background-color:#fff!important}.bg-gray-light{background-color:#fafbfc!important}.text-gray{color:#586069!important}.flex-wrap{flex-wrap:wrap!important}.flex-items-start{align-items:flex-start!important}.flex-items-center{align-items:center!important}.flex-self-stretch{align-self:stretch!important}.v-align-middle{vertical-align:middle!important}.mr-2{margin-right:8px!important}.mx-auto{margin-right:auto!important;margin-left:auto!important}.px-4{padding-right:24px!important;padding-left:24px!important}.f4{font-size:1rem!important}@media (min-width:768px){.px-md-6{padding-right:40px!important;padding-left:40px!important}.f4{font-size:1rem!important}}.f5{font-size:.875rem!important}.f00-light{font-size:2.5rem!important;font-weight:300!important}@media (min-width:768px){.f00-light{font-size:3rem!important}}.f2-light{font-size:1.375rem!important;font-weight:300!important}.lh-condensed{line-height:1.25!important}.d-flex{display:flex!important}.d-none{display:none!important}@font-face{font-family:Inter;font-style:normal;font-weight:400;src:local("Inter"),local("Inter-Regular"),url(/fonts/Inter-Regular.woff) format("woff");font-display:swap}@font-face{font-family:Inter;font-style:normal;font-weight:500;src:local("Inter Medium"),local("Inter-Medium"),url(/fonts/Inter-Medium.woff) format("woff");font-display:swap}@font-face{font-family:Inter;font-style:normal;font-weight:600;src:local("Inter Bold"),local("Inter-Bold"),url(/fonts/Inter-Bold.woff) format("woff");font-display:swap}.mb-2{margin-bottom:8px!important}.mb-3{margin-bottom:16px!important}.mb-5{margin-bottom:32px!important}.mb-6{margin-bottom:40px!important}.py-6{padding-top:40px!important;padding-bottom:40px!important}@font-face{font-family:"Atkinson Hyperlegible";font-style:normal;font-weight:400;font-display:swap;src:url(//fonts.gstatic.com/s/atkinsonhyperlegible/v10/9Bt23C1KxNDXMspQ1lPyU89-1h6ONRlW45G04pIo.woff2) format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}footer small{width:100%}footer small:last-child{text-align:end}.min-height-full{min-height:100vh}.icon-color{fill:#24292e!important}.loads{animation-duration:2s;animation:2s cubic-bezier(.4,0,.6,1) infinite pulse;animation-timing-function:cubic-bezier(.4,0,.6,1);animation-iteration-count:infinite;animation-name:pulse;background-color:var(--loading-pulse-color)}@media (min-width:768px){.f2-light{font-size:1.5rem!important}.d-md-flex{display:flex!important}#masthead{position:fixed;width:min-content}.masthead-name-mobile{display:none}}@media (max-width:768px){.masthead-mini{padding-top:10px!important;padding-bottom:10px!important}.masthead-mini-container{display:flex;align-items:center}.masthead-profile{width:80px;height:80px;margin-bottom:0!important}.masthead-intro{padding-left:24px}.masthead-name{display:none}.masthead-bio{margin-bottom:0!important}.masthead-metadata{display:none}}@media (min-width:1942px){.masthead{max-width:400px}.content-container{width:100%}}@media (prefers-color-scheme:dark){:root{--hr-color:whitesmoke;--footer-color:black;--loading-pulse-color:#383838}a{color:unset!important;text-decoration:underline}.bg-white{background-color:#4f565d!important}.bg-gray-light{background-color:#2f363d!important}.border-gray-light{border-color:transparent!important}.text-gray{color:#d0d8e1!important}.border-md-bottom{border:0!important}.masthead{background-color:#24292e!important}.scoped-text-defaults,.text-defaults,.text-defaults *{color:#fff!important}.icon-color{fill:#fff!important}}</style><body class=min-height-full id=top><div class="min-height-full bg-gray-light border-md-bottom d-md-flex"><div class="px-4 px-lg-7 py-6 bg-white border-gray-light border-md-right col-lg-4 col-md-5 col-xl-3 flex-self-stretch masthead masthead-mini px-md-6"><div class=masthead-mini-container id=masthead><a href=/ ><picture><source sizes=150px srcset="/assets/resized/me2-240-min.avif 240w, /assets/resized/me2-320-min.avif 320w, /assets/resized/me2-480-min.avif 480w, /assets/resized/me2-800-min.avif 800w, /assets/resized/me2-min.avif 1528w" type=image/avif><source sizes=150px srcset="/assets/resized/me2-240-min.jpg 240w, /assets/resized/me2-320-min.jpg 320w, /assets/resized/me2-480-min.jpg 480w, /assets/resized/me2-800-min.jpg 800w, /assets/resized/me2-min.jpg 1528w" type=image/jpeg><source sizes=150px srcset="/assets/resized/me2-240.jpg 240w, /assets/resized/me2-320.jpg 320w, /assets/resized/me2-480.jpg 480w, /assets/resized/me2-800.jpg 800w, /assets/me2.jpg 1528w"><img alt="Profile Picture" class="mb-3 circle loads masthead-profile" height=150 loading=lazy src=/assets/resized/me2-240.jpg width=150></picture></a><div class=masthead-intro><h1 class="text-defaults lh-condensed mb-2 masthead-name">Alex Saveau</h1><h2 class="text-defaults lh-condensed mb-2 masthead-name-mobile">Alex Saveau</h2><p class="text-gray f4 masthead-bio mb-3" id=bio>Relentless efficiency</div><div class="f4 masthead-metadata"><div class="text-defaults d-flex flex-items-center mb-3"><svg height=20 viewBox="0 0 16 16" aria-label=GitHub class="icon-color mr-2 octicon v-align-middle octicon-mark-github" role=img version=1.1 width=20><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg> <a href=//github.com/SUPERCILEX>@SUPERCILEX</a></div><div class="text-defaults d-flex flex-items-center mb-3"><svg height=20 viewBox="0 0 16 16" aria-label=email class="icon-color mr-2 octicon v-align-middle octicon-mail" role=img version=1.1 width=20><path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"></path></svg> <a href=mailto:saveau.alexandre@gmail.com>saveau.alexandre@gmail.com</a></div><div class="flex-items-start d-flex flex-wrap"><div class=mb-3><a href=//stackoverflow.com/u/4548500 class="tooltipped tooltipped-se" aria-label="Stack Overflow: 4548500"><svg height=24 viewBox="0 0 120 120" fill=#959da5 xmlns=http://www.w3.org/2000/svg><path d="M84.4 93.8V70.6h7.7v30.9H22.6V70.6h7.7v23.2z" class=st0 /><path d="M38.8 68.4l37.8 7.9 1.6-7.6-37.8-7.9-1.6 7.6zm5-18l35 16.3 3.2-7-35-16.4-3.2 7.1zm9.7-17.2l29.7 24.7 4.9-5.9-29.7-24.7-4.9 5.9zm19.2-18.3l-6.2 4.6 23 31 6.2-4.6-23-31zM38 86h38.6v-7.7H38V86z" class=st1 /></svg><span class=d-none>Stack Overflow</span></a></div></div></div></div></div><div class="px-4 px-lg-7 py-6 border-md-top-0 border-top col-lg-8 col-md-7 col-xl-9 content-container" id=article><div class=mx-auto style=max-width:900px><div class="f4 mb-6"><div class="f4 scoped-text-defaults"><p class=f5><a href=/blog class="text-defaults d-flex flex-items-center"><svg height=16 viewBox="0 0 16 16" aria-label=include.parent class="icon-color mr-2 octicon v-align-middle octicon-chevron-left" role=img version=1.1 width=16><path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z"></path></svg>Blog</a><h1 class="text-defaults lh-condensed f00-light" style=font-weight:600!important>Advanced Kotlin Coroutines tips and tricks</h1><h2 class="text-gray f2-light lh-condensed" style=font-weight:400!important>Learn about a few snags and how to get around them</h2><p class="text-gray mb-5">Published Oct 30, 2018 ‚Ä¢ Last updated Jun 17, 2020 ‚Ä¢ 5 min read<div class=article><p><a href=/assets/kotlin/kotlin-banner.png><picture><source sizes="(min-width: 768px) 85vw, 100vw" srcset="/assets/resized/kotlin/kotlin-banner-240-min.avif 240w, /assets/resized/kotlin/kotlin-banner-320-min.avif 320w, /assets/resized/kotlin/kotlin-banner-480-min.avif 480w, /assets/resized/kotlin/kotlin-banner-800-min.avif 800w, /assets/resized/kotlin/kotlin-banner-1600-min.avif 1600w, /assets/resized/kotlin/kotlin-banner-min.avif 1798w" type=image/avif><source sizes="(min-width: 768px) 85vw, 100vw" srcset="/assets/resized/kotlin/kotlin-banner-240-min.jpg 240w, /assets/resized/kotlin/kotlin-banner-320-min.jpg 320w, /assets/resized/kotlin/kotlin-banner-480-min.jpg 480w, /assets/resized/kotlin/kotlin-banner-800-min.jpg 800w, /assets/resized/kotlin/kotlin-banner-1600-min.jpg 1600w, /assets/resized/kotlin/kotlin-banner-min.jpg 1798w" type=image/jpeg><source sizes="(min-width: 768px) 85vw, 100vw" srcset="/assets/resized/kotlin/kotlin-banner-240.png 240w, /assets/resized/kotlin/kotlin-banner-320.png 320w, /assets/resized/kotlin/kotlin-banner-480.png 480w, /assets/resized/kotlin/kotlin-banner-800.png 800w, /assets/resized/kotlin/kotlin-banner-1600.png 1600w, /assets/kotlin/kotlin-banner.png 1798w"><img alt="Kotlin Banner" class="loads article-image" height=721 loading=lazy src=/assets/resized/kotlin/kotlin-banner-240.png width=1798></picture></a><div class=text-gray><p class=caption>Coroutines are stable as of 1.3!</div><br><p>Kotlin Coroutines starts off incredibly simple: just put some long running operation in <code class="highlighter-rouge language-plaintext">launch</code> and you‚Äôre good, right? For simple cases, sure. But pretty soon, the complexity inherent to concurrency and parallelism starts piling up.<p>Here‚Äôs what you need to know when you‚Äôre knee deep in the coroutine trenches.<h2 id=cancellation--blocking-work-->Cancellation + blocking work = üòà <a href=#cancellation--blocking-work-- class=header-link>#</a></h2><p>There‚Äôs no way to get around it: you‚Äôll have to use good ol‚Äô Java streams at some point or another. One problem (of many üòâ) with streams is that they block the current thread. That‚Äôs bad news in the coroutines world. Now, if you want to cancel a coroutine, you‚Äôll have to wait for the read or write to complete before you can continue.<p>As a simple reproducible example, let‚Äôs say you open a <code class="highlighter-rouge language-plaintext">ServerSocket</code> and wait for a connection with a 1 second timeout:</p><noscript><pre>runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)
        
         // We're stuck here forever until someone accepts. Don't you want to know the answer? üòú
        socket.accept()
    }
}
</pre></noscript><script src=//gist.github.com/7494c19538579dd0567853fe3251a973.js></script><div class=text-gray style=text-align:center><p class=gist-caption>Should work, right? Nope.</div><p>Now you‚Äôre feeling a bit like this: üòñ. So how do we fix it?<p>When <code class="highlighter-rouge language-plaintext">Closeable</code> APIs are well built, they support closing the stream from any thread and will fail appropriately.<blockquote><p>Note: in general, APIs from the JDK follow those best practices, but beware of any third party <code class="highlighter-rouge language-plaintext">Closeable</code> APIs that may not. You‚Äôve been warned.</blockquote><p>Thanks to the <code class="highlighter-rouge language-plaintext">suspendCancellableCoroutine</code> function, we can close any stream when a coroutine is cancelled:</p><noscript><pre>public suspend inline fun &lt;T : Closeable?, R> T.useCancellably(
        crossinline block: (T) -> R
): R = suspendCancellableCoroutine { cont ->
    cont.invokeOnCancellation { this?.close() }
    cont.resume(use(block))
}
</pre></noscript><script src=//gist.github.com/ebacfb46c24156c7af020da63cf37822.js></script><div class=text-gray style=text-align:center><p class=gist-caption>Be sure this works with the API you are using!</div><p>Now that our blocking <code class="highlighter-rouge language-plaintext">accept</code> call is wrapped in <code class="highlighter-rouge language-plaintext">useCancellably</code>, the coroutine will fail when the timeout occurs.</p><noscript><pre>runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)

        // Blows up with `SocketException: socket closed`. Yay!
        socket.useCancellably { it.accept() }
    }
}
</pre></noscript><script src=//gist.github.com/05c9453e8afd48fc1651b2b611a2f3cf.js></script><div class=text-gray style=text-align:center><p class=gist-caption>Success!</div><p>But what if you can‚Äôt support cancellation at all? Here‚Äôs what you need to watch out for:<ul><li>If you use any instance properties/functions from your coroutine‚Äôs enclosing class, it will be leaked even if you cancel the coroutine. This is especially relevant if you think you‚Äôre cleaning up resources in <code class="highlighter-rouge language-plaintext">onDestroy</code>. <strong>Workaround:</strong> move the coroutine to a <code class="highlighter-rouge language-plaintext">ViewModel</code> or other non-context class and subscribe to its result.<li>Make sure to use <code class="highlighter-rouge language-plaintext">Dispatchers.IO</code> for blocking work since that allows Kotlin to set aside some threads that it expects to be waiting indefinitely.<li>Use <code class="highlighter-rouge language-plaintext">suspendCancellableCoroutine</code> over <code class="highlighter-rouge language-plaintext">suspendCoroutine</code> wherever possible.</ul><h2 id=launch-vs-async><code class="highlighter-rouge language-plaintext">launch</code> vs. <code class="highlighter-rouge language-plaintext">async</code> <a href=#launch-vs-async class=header-link>#</a></h2><p>Since the top SO answers about these two builders are out-of-date, I thought I‚Äôd touch upon their differences again.<h3 id=launch-bubbles-up-exceptions><code class="highlighter-rouge language-plaintext">launch</code> bubbles up exceptions <a href=#launch-bubbles-up-exceptions class=header-link>#</a></h3><p>When a coroutines crashes, its parent is cancelled which in turn cancels all the parent‚Äôs children. Once coroutines throughout the tree have finished cancelling, the exception is sent to the current context‚Äôs exception handler. On Android, that means <em>your app will crash</em>, regardless of what dispatcher you were using.<h3 id=async-holds-on-to-its-exceptions><code class="highlighter-rouge language-plaintext">async</code> holds on to its exceptions <a href=#async-holds-on-to-its-exceptions class=header-link>#</a></h3><p>That means <code class="highlighter-rouge language-plaintext">await()</code> explicitly handles all exceptions and installing a <code class="highlighter-rouge language-plaintext">CoroutineExceptionHandler</code> will have no effect.<h3 id=launch-blocks-the-parent-scope><code class="highlighter-rouge language-plaintext">launch</code> ‚Äúblocks‚Äù the parent scope <a href=#launch-blocks-the-parent-scope class=header-link>#</a></h3><p>While the function will return immediately, its parent scope will <em>not</em> finish until all coroutines built with <code class="highlighter-rouge language-plaintext">launch</code> have completed one way or another. This makes calling <code class="highlighter-rouge language-plaintext">join()</code> for all your child jobs at the end of the parent unnecessary if you simply want to wait for those coroutines to finish.<p>Unlike what you might expect, the outer scope will still wait for <code class="highlighter-rouge language-plaintext">async</code> coroutines to complete even if <code class="highlighter-rouge language-plaintext">await()</code> is not called.<h3 id=async-returns-a-result><code class="highlighter-rouge language-plaintext">async</code> returns a result <a href=#async-returns-a-result class=header-link>#</a></h3><p>This one‚Äôs pretty simple: if you need a result out of your coroutine, <code class="highlighter-rouge language-plaintext">async</code> is your only option. If you don‚Äôt need a result, use <code class="highlighter-rouge language-plaintext">launch</code> to create side effects. And only if you need those side effects to complete before moving on do you need to use <code class="highlighter-rouge language-plaintext">join()</code>.<h3 id=join-vs-await><code class="highlighter-rouge language-plaintext">join()</code> vs. <code class="highlighter-rouge language-plaintext">await()</code> <a href=#join-vs-await class=header-link>#</a></h3><p><code class="highlighter-rouge language-plaintext">join()</code> does <em>not</em> rethrow exceptions while <code class="highlighter-rouge language-plaintext">await()</code> will. However, <code class="highlighter-rouge language-plaintext">join()</code> cancels your coroutine if an error occurred, meaning any code after the suspending call to <code class="highlighter-rouge language-plaintext">join()</code> is not invoked.<h2 id=logging-exceptions>Logging exceptions <a href=#logging-exceptions class=header-link>#</a></h2><p>Now that you understand how differently exceptions are handled depending on which builder you use, you‚Äôre left with a dilemma: you want to log exceptions without crashing (so we can‚Äôt use <code class="highlighter-rouge language-plaintext">launch</code>), but you don‚Äôt want to manually <code class="highlighter-rouge language-plaintext">try</code>/<code class="highlighter-rouge language-plaintext">catch</code> them all (so we can‚Äôt use <code class="highlighter-rouge language-plaintext">async</code>). So that leaves us with‚Ä¶ nothing? Thankfully not.<p>Logging exceptions is where the <code class="highlighter-rouge language-plaintext">CoroutineExceptionHandler</code> comes in handy. But first, let‚Äôs take a moment to understand what actually happens when an exception is thrown in a coroutine:<ol><li>The exception is caught and then resumed through a <code class="highlighter-rouge language-plaintext">Continuation</code>.<li>If your code doesn‚Äôt handle the exception and it isn‚Äôt a <code class="highlighter-rouge language-plaintext">CancellationException</code>, the first <code class="highlighter-rouge language-plaintext">CoroutineExceptionHandler</code> is requested through the current <code class="highlighter-rouge language-plaintext">CoroutineContext</code>.<li>If a handler isn‚Äôt found or it errors, the exception is sent to platform specific code.<li>On the JVM, a <code class="highlighter-rouge language-plaintext">ServiceLoader</code> is used to locate global handlers.<li>Once all handlers have been invoked or one of them errors, the current thread‚Äôs exception handler gets invoked.<li>If the current thread doesn‚Äôt handle the exception, it bubbles up to the thread group and then finally to the default exception handler.<li>Crash!</ol><p>With that in mind, we have a few options:<ul><li>Install a handler per thread, but that‚Äôs not realistic.<li>Install the default handler, but then errors from the main thread won‚Äôt crash your app and you‚Äôll be left in a potentially bad state.<li><a href=//gist.github.com/SUPERCILEX/f4b01ccf6fd4ef7ec0a85dbd59c89d6c>Add the handler as a service</a> which will be invoked when any coroutine built with <code class="highlighter-rouge language-plaintext">launch</code> crashes (hacky).<li>Use your own custom scope with a handler attached instead of <code class="highlighter-rouge language-plaintext">GlobalScope</code> or add the handler to every scope you use, but that‚Äôs annoying and makes logging optional instead of the default.</ul><p>That last solution is preferred because it is flexible while requiring minimal code and hacks.<p>For app wide jobs, you‚Äôll use an <code class="highlighter-rouge language-plaintext">AppScope</code> with a logging handler. For any other jobs, you can add the handler when logging is appropriate over crashing.</p><noscript><pre>val LoggingExceptionHandler = CoroutineExceptionHandler { _, t ->
    Crashlytics.logException(t)
}
val AppScope = GlobalScope + LoggingExceptionHandler
</pre></noscript><script src=//gist.github.com/0dcb8468c7b19ff1a901dc730fb86828.js></script><div class=text-gray style=text-align:center><p class=gist-caption>Not too shabby</div><h2 id=closing-thoughts>Closing thoughts <a href=#closing-thoughts class=header-link>#</a></h2><p>Anytime we have to deal with edge cases, things get messy pretty fast. I hope this article helped you understand the variety of problems you can run into given subpar conditions and what potential solutions you can apply.<hr><p>Happy Kotlining!</div></div></div></div></div></div><footer class=text-defaults><small>Copyright ¬© 2018-2026 Alex Saveau</small> <small><a href=//github.com/SUPERCILEX/personal-website>Source</a> | <a href=//twitter.com/SUPERCILEX>Twitter</a> | <a href=#top>Back to top</a></small></footer>